<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Firebase Phone Auth Test</title>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
      import {
        getAuth,
        RecaptchaVerifier,
        signInWithPhoneNumber,
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCBE9bMhCvFE9UmamzVFyW6IIYRQBy-YdY",
        authDomain: "pankhuri-74073.firebaseapp.com",
        projectId: "pankhuri-74073",
        storageBucket: "pankhuri-74073.firebasestorage.app",
        messagingSenderId: "254532886233",
        appId: "1:254532886233:web:5f46e2dadda8eb507ca8c8",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      // ‚úÖ Initialize reCAPTCHA once (visible for reliability)
      window.recaptchaVerifier = new RecaptchaVerifier(auth, "recaptcha-container", {
        size: "normal", // change from "invisible" to "normal"
        callback: (response) => {
          console.log("reCAPTCHA solved:", response);
        },
      });

      window.recaptchaVerifier.render().then((widgetId) => {
        window.recaptchaWidgetId = widgetId;
      });

      // ‚úÖ Send OTP
      let confirmationResult;

      document.getElementById("send-otp").addEventListener("click", async () => {
        const phoneNumber = document.getElementById("phone").value.trim();
        if (!phoneNumber) return alert("Please enter a phone number with +91 prefix.");

        try {
          document.getElementById("send-otp").innerText = "Sending...";
          document.getElementById("send-otp").disabled = true;

          confirmationResult = await signInWithPhoneNumber(
            auth,
            phoneNumber,
            window.recaptchaVerifier
          );

          alert("OTP sent! Check your phone.");
          document.getElementById("otp-section").style.display = "block";
          document.getElementById("otp").focus();
        } catch (error) {
          console.error("‚ùå Error:", error);
          alert("Error: " + error.message);
          document.getElementById("send-otp").innerText = "Send OTP";
          document.getElementById("send-otp").disabled = false;
        }
      });

      // ‚úÖ Verify OTP
      document.getElementById("verify-otp").addEventListener("click", async () => {
        const otp = document.getElementById("otp").value.trim();
        if (!otp) return alert("Please enter the OTP!");

        try {
          document.getElementById("verify-otp").innerText = "Verifying...";
          document.getElementById("verify-otp").disabled = true;

          const result = await confirmationResult.confirm(otp);
          const idToken = await result.user.getIdToken();

          document.getElementById("token").value = idToken;
          document.getElementById("copy-btn").style.display = "inline-block";
          console.log("‚úÖ Firebase ID Token:", idToken);
          alert("‚úÖ OTP verified! Token shown below.");
        } catch (error) {
          console.error("‚ùå Error:", error);
          alert("Error: " + error.message);
          document.getElementById("verify-otp").innerText = "Verify OTP";
          document.getElementById("verify-otp").disabled = false;
        }
      });

      // ‚úÖ Copy token
      window.copyToken = function () {
        const tokenBox = document.getElementById("token");
        tokenBox.select();
        document.execCommand("copy");
        alert("Token copied to clipboard!");
      };
    </script>

    <style>
      body {
        font-family: "Google Sans", Arial, sans-serif;
        background: #f7f8fa;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        color: #333;
      }

      .container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        width: 380px;
        text-align: center;
      }

      h2 {
        color: #202124;
        margin-bottom: 1rem;
      }

      input {
        width: 100%;
        padding: 10px;
        margin: 0.5rem 0 1rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
      }

      button {
        background-color: #1a73e8;
        color: white;
        border: none;
        padding: 10px 16px;
        font-size: 16px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      button:hover {
        background-color: #1669c1;
      }

      textarea {
        width: 100%;
        height: 140px;
        margin-top: 1rem;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ddd;
        font-family: monospace;
        font-size: 13px;
        background: #f9f9f9;
      }

      #recaptcha-container {
        margin-top: 1rem;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h2>üì± Firebase Phone Auth</h2>
      <p>Enter your phone number to receive an OTP and get your Firebase ID token.</p>

      <input id="phone" type="text" placeholder="+91XXXXXXXXXX" />
      <button id="send-otp">Send OTP</button>
      <div id="recaptcha-container"></div>

      <div id="otp-section" style="display: none; margin-top: 1.5rem">
        <h4>Enter OTP:</h4>
        <input id="otp" type="text" placeholder="Enter 6-digit OTP" maxlength="6" />
        <button id="verify-otp">Verify OTP</button>
      </div>

      <h4 style="margin-top: 1.5rem">Your ID Token:</h4>
      <textarea id="token" readonly></textarea>
      <button onclick="copyToken()" style="display: none" id="copy-btn">Copy Token</button>
    </div>
  </body>
</html>
